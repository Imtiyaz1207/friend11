from flask import Flask, render_template, request, jsonify
from datetime import datetime
import cloudinary
import cloudinary.uploader
from dotenv import load_dotenv
from werkzeug.utils import secure_filename
import os, json, requests, pytz

app = Flask(__name__)

# Load environment variables
load_dotenv()

CLOUDINARY_CLOUD_NAME = os.getenv("CLOUDINARY_CLOUD_NAME")
CLOUDINARY_API_KEY = os.getenv("CLOUDINARY_API_KEY")
CLOUDINARY_API_SECRET = os.getenv("CLOUDINARY_API_SECRET")
GOOGLE_SCRIPT_URL = os.getenv("GOOGLE_SCRIPT_URL")

# Configure Cloudinary
cloudinary.config(
    cloud_name=CLOUDINARY_CLOUD_NAME,
    api_key=CLOUDINARY_API_KEY,
    api_secret=CLOUDINARY_API_SECRET
)

VIDEO_STORE_FILE = "last_video.json"

# ==============================
# Helpers
# ==============================
def save_last_video(video_url):
    """Cache the last uploaded video locally"""
    try:
        with open(VIDEO_STORE_FILE, "w") as f:
            json.dump({"video_url": video_url}, f)
    except Exception as e:
        print("‚ö†Ô∏è Failed to save last video:", e)


def get_last_video():
    """Fetch the most recent video URL from Google Sheet, fallback to local cache"""
    try:
        response = requests.get(GOOGLE_SCRIPT_URL, timeout=10)
        data = response.json()
        video_url = data.get("video_url")
        if video_url:
            save_last_video(video_url)  # cache locally
            return video_url
    except Exception as e:
        print("‚ö†Ô∏è Could not fetch latest video from Google Sheet:", e)

    # fallback to local file if Google fails
    if os.path.exists(VIDEO_STORE_FILE):
        try:
            with open(VIDEO_STORE_FILE, "r") as f:
                data = json.load(f)
                return data.get("video_url")
        except:
            pass
    return None


# ==============================
# Routes
# ==============================
@app.route("/")
def index():
    video_url = get_last_video()

    # ‚úÖ Log page visit automatically
    try:
        ip_address = request.headers.get("X-Forwarded-For", request.remote_addr)
        india_time = datetime.now(pytz.timezone("Asia/Kolkata")).strftime("%Y-%m-%d %H:%M:%S")

        payload = {
            "timestamp": india_time,
            "event": "page_visit",
            "ip_address": ip_address,
            "password_attempt": "",
            "result": "visited"
        }

        if GOOGLE_SCRIPT_URL:
            requests.post(GOOGLE_SCRIPT_URL, json=payload, timeout=10)
    except Exception as e:
        print("‚ö†Ô∏è Failed to log page visit:", e)

    return render_template("index.html", datetime=datetime, video_url=video_url)


# ==============================
# Logging to Google Sheet
# ==============================
@app.route("/log_action", methods=["POST"])
def log_action():
    """Log password attempts or button clicks to Google Sheet"""
    try:
        data = request.get_json(force=True)
        print("LOG:", data)

        password_attempt = data.get("password", "")
        event = data.get("action", "password_attempt" if password_attempt else "unknown")

        result = "success" if password_attempt == "23E51A05C1" else "failed" if password_attempt else "clicked"
        ip_address = request.headers.get("X-Forwarded-For", request.remote_addr)
        india_time = datetime.now(pytz.timezone("Asia/Kolkata")).strftime("%Y-%m-%d %H:%M:%S")

        payload = {
            "timestamp": india_time,
            "event": event,
            "ip_address": ip_address,
            "password_attempt": password_attempt,
            "result": result
        }

        if GOOGLE_SCRIPT_URL:
            try:
                requests.post(GOOGLE_SCRIPT_URL, json=payload, timeout=10)
            except Exception as e:
                print("‚ö†Ô∏è Google Sheet log failed:", e)

        return jsonify({"status": "ok", "result": result})

    except Exception as e:
        print("Log Error:", e)
        return jsonify({"status": "error", "error": str(e)})


# ==============================
# Upload Story (Cloudinary)
# ==============================
@app.route("/upload_story", methods=["POST"])
def upload_story():
    """Upload video to Cloudinary"""
    try:
        if "video" not in request.files:
            return jsonify({"status": "error", "error": "No video part"})

        video = request.files["video"]
        if video.filename == "":
            return jsonify({"status": "error", "error": "No selected file"})

        filename = secure_filename(video.filename)
        print("Uploading to Cloudinary:", filename)

        upload_result = cloudinary.uploader.upload(
            video,
            resource_type="video",
            folder="stories"
        )

        video_url = upload_result.get("secure_url")
        print("‚úÖ Upload successful:", video_url)

        save_last_video(video_url)

        # Log upload to Google Sheet
        ip_address = request.headers.get("X-Forwarded-For", request.remote_addr)
        india_time = datetime.now(pytz.timezone("Asia/Kolkata")).strftime("%Y-%m-%d %H:%M:%S")

        log_data = {
            "timestamp": india_time,
            "event": "video_uploaded",
            "ip_address": ip_address,
            "password_attempt": filename,
            "video_url": video_url,
            "result": "uploaded"
        }

        if GOOGLE_SCRIPT_URL:
            try:
                requests.post(GOOGLE_SCRIPT_URL, json=log_data, timeout=10)
            except Exception as e:
                print("‚ö†Ô∏è Failed to log upload:", e)

        return jsonify({"status": "ok", "video_url": video_url})

    except Exception as e:
        print("Upload Error:", e)
        return jsonify({"status": "error", "error": str(e)})


if __name__ == "__main__":
    app.run(debug=True)



<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üíñ Secret Message üíñ</title>
  <style>
    body {
      background: radial-gradient(circle at top left, #e36da4, #e01f9c);
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      font-family: "Poppins", sans-serif;
      text-align: center;
      margin: 0;
      padding: 0 20px;
    }

    .container {
      background: rgba(243, 237, 243, 0.65);
      padding: 60px 30px;
      border-radius: 20px;
      box-shadow: 0 0 20px rgba(117, 89, 89, 0.3);
      max-width: 500px;
      width: 100%;
      opacity: 1;
      transition: opacity 0.3s ease, transform 0.1s ease;
      position: relative;
      text-align: center;
    }

    input { 
      padding: 10px; 
      border: none; 
      border-radius: 10px; 
      width: 80%; 
      margin-top: 15px; 
      font-size: 16px; 
      text-align: center; 
    }

    button { 
      margin-top: 20px; 
      padding: 10px 20px; 
      border-radius: 10px; 
      border: none; 
      background-color: #0e0808; 
      color: white; 
      font-weight: bold; 
      cursor: pointer; 
      transition: transform 0.1s ease, background-color 0.3s ease;
    }

    button:hover { 
      background-color: #ff6b81; 
    }

    #message, #uploadMsg { display: none; opacity: 0; transition: opacity 0.5s ease; }

    #errorMsg {
      color: red;
      margin-top: 10px;
      font-weight: bold;
      display: none;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    @keyframes shake {
      0% { transform: translateX(0); }
      20% { transform: translateX(-6px); }
      40% { transform: translateX(6px); }
      60% { transform: translateX(-6px); }
      80% { transform: translateX(6px); }
      100% { transform: translateX(0); }
    }
    .shake { animation: shake 0.35s; }

    /* ===== Updated video ===== */
    #secretVideo {
      display: none;
      margin: 20px auto;
      border-radius: 20px;
      width: 480px;     /* bigger on desktop */
      height: 360px;
      max-width: 90%;   /* responsive */
      box-shadow: 0 0 20px rgba(0,0,0,0.3);
    }

    .upload-container { 
      margin-top: 5px; 
      text-align: center; 
    }

    .upload-controls { 
      display: flex; 
      justify-content: center; 
      align-items: center; 
      gap: 5px; 
      flex-wrap: wrap; 
      margin-top: 10px; 
    }

    .upload-controls input[type="file"] { 
      background: white; 
      border-radius: 10px; 
      padding: 6px; 
      border: 1px solid #ddd; 
    }

    .upload-controls button { 
      background-color: #0e0808; 
      color: white; 
      border: none; 
      padding: 10px 18px; 
      border-radius: 10px; 
      font-weight: bold; 
      cursor: pointer; 
      transition: background-color 0.3s ease; 
    }

    .upload-controls button:hover { 
      background-color: #ff6b81; 
    }

    #progressContainer {
      display: none;
      width: 80%;
      margin: 10px auto;
      background: rgba(255,255,255,0.6);
      border-radius: 10px;
      height: 10px;
      overflow: hidden;
    }

    #progressBar {
      width: 0%;
      height: 100%;
      background-color: #ff4da6;
      transition: width 0.3s ease;
    }

    /* ===== Footer ===== */
    #footer {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      text-align: center;
      padding: 10px 0;
      font-family: "Poppins", sans-serif;
      font-size: 16px;
      color: white;
      background: rgba(0,0,0,0.3);
      z-index: 1000;
    }

    /* ===== Mobile ===== */
    @media(max-width:480px){
      .container { padding:40px 20px; } 
      input { width:90%; } 
      h1{font-size:24px;} 
      p{font-size:16px;} 
      #secretVideo { width: 90%; height: auto; }
      #footer { font-size: 14px; padding: 8px 0; }
    }
  </style>
</head>
<body>

<audio id="bgMusic" src="static/Music.mp3" loop preload="auto"></audio>

<div id="login" class="container">
  <h1>Hii..‚ú®</h1>
  <p style="font-size:25px;color:#333;">Enter the Previous same password</p>
  <input type="password" id="password" placeholder="Enter password">
  <button onclick="checkPassword()">Submit</button>
  <div id="errorMsg">‚ùå Wrong password! Try again</div>
</div>

<div id="message" class="container">
  <h1>Hii Fathima!</h1>
  <p>Agar aap yeh message padre tho plzz at least kuch tho response dho...I really want to be your friendüå∏</p><P></P>
  <p>I'll wait for your response üòäüí´</p>
  <p></p>

  <button onclick="playVideo()">For youüòäü¶ã</button>
  <p id="tapText">Tap here üëÜ</p>

  <video id="secretVideo" controls>
    {% if video_url %}
      <source src="{{ video_url }}" type="video/mp4">
    {% endif %}
  </video>

  <div id="uploadSection" class="upload-container">
    <div class="upload-controls">
      <input type="file" id="videoUpload" accept="video/*">
      <button onclick="uploadStory()">Upload</button>
    </div>

    <div id="progressContainer">
      <div id="progressBar"></div>
    </div>

    <p id="uploadMsg" style="color:#000; display:none;">Uploading...</p>
  </div>
</div>

<!-- ===== Footer ===== -->
<footer id="footer"> Builtb with‚ù§Ô∏è by Shaiküí´</footer>

<script>
const bgMusic = document.getElementById("bgMusic");
const loginDiv = document.getElementById("login");
const messageDiv = document.getElementById("message");
const errorMsg = document.getElementById("errorMsg");

function fadeInMusic(audio, duration=2000) {
  audio.currentTime = 7;
  audio.volume = 0;
  audio.play().catch(err => console.log("Autoplay blocked:", err));
  const step = 0.02;
  const interval = setInterval(() => {
    if(audio.volume < 0.5) audio.volume += step;
    else clearInterval(interval);
  }, duration/50);
}

function showErrorMessage() {
  errorMsg.style.display = "block";
  setTimeout(() => { errorMsg.style.opacity = 1; }, 50);
  loginDiv.classList.add("shake");
  setTimeout(() => { loginDiv.classList.remove("shake"); }, 350);
  setTimeout(() => {
    errorMsg.style.opacity = 0;
    setTimeout(() => { errorMsg.style.display = "none"; }, 300);
  }, 2000);
}

function checkPassword() {
  const entered = document.getElementById("password").value.trim();
  errorMsg.style.opacity = 0;
  errorMsg.style.display = "none";

  fetch("/log_action", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ password: entered })
  }).catch(err => console.log("Logging failed:", err));

  if(entered === "23E51A05C1"){
    loginDiv.style.opacity = 0;
    setTimeout(() => {
      loginDiv.style.display = "none";
      messageDiv.style.display = "block";
      setTimeout(()=> { messageDiv.style.opacity = 1; }, 50);
    }, 300);
    fadeInMusic(bgMusic, 1500);
  } else {
    showErrorMessage();
  }
}

function playVideo() {
  const video = document.getElementById("secretVideo");
  const button = event.target;
  const tapText = document.getElementById("tapText");
  bgMusic.pause();

  fetch("/log_action", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ action: "video_button_clicked" })
  }).catch(err => console.log("Logging failed:", err));

  button.style.display = "none";
  if (tapText) tapText.style.display = "none";
  video.style.display = "block";
  video.play();
  sessionStorage.setItem("videoShown", "true");

  video.onended = () => {
    bgMusic.pause();
    bgMusic.currentTime = 0;
  };
}

function uploadStory() {
  const fileInput = document.getElementById("videoUpload");
  const uploadMsg = document.getElementById("uploadMsg");
  const progressContainer = document.getElementById("progressContainer");
  const progressBar = document.getElementById("progressBar");

  if (!fileInput.files.length) {
    alert("Please select a video first!");
    return;
  }

  const formData = new FormData();
  formData.append("video", fileInput.files[0]);

  uploadMsg.style.display = "block";
  uploadMsg.textContent = "Uploading...";
  progressContainer.style.display = "block";
  progressBar.style.width = "0%";

  const xhr = new XMLHttpRequest();
  xhr.open("POST", "/upload_story", true);

  xhr.upload.onprogress = function (e) {
    if (e.lengthComputable) {
      const percent = Math.round((e.loaded / e.total) * 100);
      progressBar.style.width = percent + "%";
      uploadMsg.textContent = `Uploading... ${percent}%`;
    }
  };

  xhr.onload = function () {
    progressContainer.style.display = "none";
    if (xhr.status === 200) {
      const result = JSON.parse(xhr.responseText);
      if (result.status === "ok") {
        uploadMsg.textContent = "‚úÖ Upload complete!";
        const video = document.getElementById("secretVideo");
        video.src = result.video_url + "?t=" + new Date().getTime();
        video.load();
      } else {
        uploadMsg.textContent = "‚ùå Upload failed.";
      }
    } else {
      uploadMsg.textContent = "‚ùå Server error.";
    }
  };

  xhr.onerror = function () {
    progressContainer.style.display = "none";
    uploadMsg.textContent = "‚ùå Upload error.";
  };

  xhr.send(formData);
}

window.addEventListener("load", () => {
  fetch("/log_action", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ event: "page_visit" })
  }).catch(err => console.log("Logging failed:", err));
});
</script>

</body>
</html>

Flask==2.3.2
requests==2.32.1
python-dotenv==1.0.0
gunicorn==21.2.0
pytz==2024.1
Werkzeug==3.1.2
cloudinary
